Пример:
Order Management -REST-> Order Delivery -> setData to DB

сохранили данные, что нужно доставить заказ, через какое-то время заказ отменяют, нам нужно снова сходить в Order Delivery и убрать запись

но сервис Order Delivery перегружен или упал, тогда заказ будет доставлен

Использование брокера сообщений:

Order Management -> 1 Broker -> Order Delivery -> setData to DB

но кафка упала и обновления не дошли

Использование паттерна Transactional Outbox:

Если бизнес-объект и соответствующие сообщения сохраняются в рамках одной транзакции базы данных, это гарантирует, что данные не будут потеряны

данные будут сохранены в таблице outbox на стороне order management

то есть эта атомарность дает нам то, что данные будут доставлены, если есть запись в таблице outbox

после того как сообщение закомитится в бд - запустится процесс обработки этого сообщения

Плюсы:
не нужно беспокоиться о том, что брокер или сервис будут недоступны, все сообщения сохраняются в базу и будут обработаны, когда недоступные сервисы оживут
гарантируется атомарность - если сообщение в базе - то выполняется операция, если нет сообщения в базе - не выполняется

можно сделать так, что этот outbox processor будет читать закомиченные сообщения в бд и отправлять в брокер сообщений, потом например обновлять статус в таблице outbox

#микросервисныеПаттерны